<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="title">MARF Hire Operators</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/906faa9c3f.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary-green: #173c1c;
            --soft-earth-tone: #e8f5e9;
            --accent-orange: #FFA500;
            --accent-dark: #CC8400;
            --text-dark: #173c1c;
            --text-light: #fff;
        }
        body {
            font-family: 'Poppins', 'Noto Sans Kannada', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            background-color: var(--soft-earth-tone);
            line-height: 1.8;
        }
        .hidden { display: none !important; }
        .animate-pulse-slow {
            animation: pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 1px rgba(255, 165, 0, 0.4)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 8px rgba(255, 165, 0, 0.8)); transform: scale(1.05); }
        }
        header {
            background-color: white; color: var(--text-dark); padding: 1.5rem 20px;
            margin-bottom: 10px; display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; height: 50px;
            z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-logo-text img{ width: 100%; height: 70px; margin-left: 40px; }
        .desktop-nav { display: none; }
        @media (min-width: 768px) { .desktop-nav { display: flex; flex-grow: 1; justify-content: center; gap: 30px; } }
        .desktop-nav a {
            display: flex; align-items: center; gap: 1rem; color: var(--text-dark);
            text-decoration: none; font-weight: 500; font-size: 1.3rem;
            position: relative; transition: color 0.3s; margin-right: 15px;
        }
        .nav-link:hover { color: var(--primary-green); }
        .nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 4px;
            background-color: #173c1c; border-radius: 2px; transition: width 0.3s ease, left 0.3s ease;
        }
        .nav-link:hover::after { width: 100%; left: 0; }
        .desktop-search-container { display: none; }
        @media (min-width: 768px) { .desktop-search-container { display: flex; width: 25%; align-items: center; gap: 15px; margin-right: 40px; } }
        .desktop-search-bar {
            display: flex; align-items: center; width: 100%; height: 40px; gap: 0.5rem;
            background-color: #f3f4f6; border-radius: 9999px; padding: 0.5rem 1rem; border: 1px solid #e5e7eb;
        }
        .desktop-search-bar input { background: transparent; font-size: 1.3rem; border: none; outline: none; color: var(--text-dark); }
        .location-detector-btn {
            background: none; border: none; color: var(--accent-orange); padding: 0.5rem;
            margin-left: 20px; border-radius: 50%; cursor: pointer; transition: transform 0.3s;
        }
        .location-detector-btn i{ width: 100%; }
        .location-detector-btn:hover { transform: scale(1.1); }
        .mobile-header-group { display: flex; align-items: center; gap: 1rem; }
        .mobile-menu-button { background: none; border: none; color: var(--primary-green); cursor: pointer; }
        @media (min-width: 768px) { .mobile-menu-button { display: none; } }
        .mobile-nav-menu {
            display: none; flex-direction: column; gap: 10px; width: 100%;
            padding: 1rem 0; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 10px;
        }
        .user-menu-dropdown-container { position: relative; }
        .user-menu-button { background: var(--soft-earth-tone); border: none; color: var(--primary-green); padding: 0.5rem; border-radius: 50%; cursor: pointer; transition: background-color 0.3s; }
        .user-menu-button:hover { background-color: rgba(23, 60, 28, 0.1); }
        .user-dropdown { position: absolute; top: 112%; right: 0; margin-top: 10px; width: 350px; background-color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; }
        .logout-btn{ background-color: #173c1c; margin: 0 auto; color: white; border-radius: 15px; height: 50px; width: 160px; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .logout-btn:hover{ background-color: var(--soft-earth-tone); color: var(--text-dark); }
        .main-content { padding: 2rem 1rem; max-width: 1200px; margin: 0 auto; }
        .main-content h2, .operators-section h3 { text-align: center; margin: 1rem auto; font-size: 2.8rem; color: var(--primary-green); }
        .sub-heading { font-size: 1.5rem; color: var(--primary-green); margin-bottom: 1rem; }
        .register-form-card { background-color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--primary-green); padding: 2rem; margin-bottom: 4rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-size: 1.4rem; font-weight: 600; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem 1rem; border-radius: 5px; border: 1px solid var(--text-dark); background-color: #f3f4f6; font-size: 1.2rem; box-sizing: border-box; }
        .input-with-icon { display: flex; align-items: center; gap: 0.5rem; }
        .input-with-icon input { flex-grow: 1; }
        .verify-location-btn { background-color: var(--accent-orange); color: white; border: none; padding: 0 1rem; border-radius: 5px; cursor: pointer; font-size: 1rem; height: 48px; }
        .form-buttons { display: flex; justify-content: flex-end; }
        .submit-btn { background-color: var(--primary-green); color: var(--text-light); padding: 1rem 2rem; border-radius: 5px; font-size: 1.1rem; font-weight: 700; cursor: pointer; border: none; width: 100%; }
        .search-container { max-width: 600px; margin: 0 auto 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .search-bar { display: flex; align-items: center; gap: 0.5rem; background-color: white; border-radius: 9999px; padding: 0.5rem 1rem; border: 1px solid #e5e7eb; }
        .search-bar input { background: transparent; border: none; outline: none; width: 100%; }
        .search-bar button { background-color: var(--primary-green); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; }
        .operators-filters { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .operators-filters select { padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid var(--text-dark); background-color: white; font-size: 1rem; }
        .operators-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
        .operator-card { background-color: white; border-radius: 10px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--primary-green); display: flex; flex-direction: column; }
        .operator-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .status-available { color: #2c6032; font-weight: 700; }
        .status-unavailable { color: #d9534f; font-weight: 700; }
        .operator-name { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .operator-meta { flex-grow: 1; margin: 1rem 0 1.5rem 0; }
        .operator-meta span { display: flex; align-items: center; gap: 0.5rem; }
        .operator-distance { font-size: 0.9rem; font-weight: normal; color: #666; }
        .hire-btn { background-color: var(--primary-green); color: var(--text-light); padding: 1rem; border-radius: 5px; font-size: 1.1rem; font-weight: 700; cursor: pointer; border: none; width: 100%; }
        .message-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1001; text-align: center; border: 1px solid var(--primary-green); }
        footer { width: 100%; background-color: var(--primary-green); color: var(--text-light); text-align: center; padding: 20px 0 5px; }
        .legal-links p { font-size: 1.3rem; color: var(--text-light); border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <header>
        </header>

    <main class="main-content">
        <h2 class="section-heading font-poppins" data-key="main_title">Hire Operators</h2>
        <section class="register-form-card">
            <h3 class="sub-heading" data-key="register_operator_title">Register as an Operator</h3>
            <form id="register-operator-form">
                <div class="form-group">
                    <label for="operator-name" data-key="operator_name_label">Operator Name</label>
                    <div class="input-with-icon"><i class="fas fa-user"></i><input type="text" id="operator-name" required></div>
                </div>
                <div class="form-group">
                    <label for="contact-number" data-key="contact_number_label">Contact Number</label>
                    <div class="input-with-icon"><i class="fas fa-phone"></i><input type="tel" id="contact-number" required></div>
                </div>
                <div class="form-group">
                    <label for="location" data-key="your_location_label">Your Location (e.g., "Bengaluru, Karnataka")</label>
                    <div class="input-with-icon">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="location" placeholder="Enter a verifiable address" required>
                        <button type="button" id="verify-location-btn" class="verify-location-btn" data-key="verify_location_btn">Verify</button>
                    </div>
                    <input type="hidden" id="latitude">
                    <input type="hidden" id="longitude">
                </div>
                <div class="form-group">
                    <label for="availability" data-key="availability_label">Availability</label>
                    <select id="availability">
                        <option value="available" data-key="availability_available">Available</option>
                        <option value="unavailable" data-key="availability_unavailable">Not Available</option>
                    </select>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="submit-btn" data-key="register_btn">Register</button>
                </div>
            </form>
        </section>

        <section class="operators-section">
            <h3 data-key="find_operators_title">Find Nearby Operators</h3>
            <div class="search-container">
                <div class="search-bar">
                    <i class="fas fa-user"></i>
                    <input type="text" id="operator-name-search" placeholder="Search by operator name..." data-key-placeholder="operator_name_search_placeholder">
                </div>
                <div class="search-bar">
                    <i class="fas fa-map-marker-alt"></i>
                    <input type="text" id="location-search" placeholder="Enter a location to search near..." data-key-placeholder="location_search_placeholder">
                    <button id="location-search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="operators-filters">
                <select id="availability-filter">
                    <option value="all" data-key="filter_all">All Availabilities</option>
                    <option value="available" data-key="filter_available">Available Only</option>
                </select>
                <select id="distance-filter">
                    <option value="any" data-key="filter_any">Any distance</option>
                    <option value="5">Within 5 km</option>
                    <option value="10">Within 10 km</option>
                    <option value="25">Within 25 km</option>
                    <option value="50">Within 50 km</option>
                </select>
            </div>
            <div id="operators-grid" class="operators-grid">
                </div>
        </section>
    </main>

    <div id="success-modal" class="message-modal hidden">
        </div>
    <footer>
        </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE_URL = 'http://127.0.0.1:5000';
            let searchCoordinates = null; // Holds {lat, lng} for the current search

            // --- DOM Elements ---
            const operatorGrid = document.getElementById('operators-grid');
            const operatorNameSearchInput = document.getElementById('operator-name-search');
            const locationSearchInput = document.getElementById('location-search');
            const locationSearchBtn = document.getElementById('location-search-btn');
            const availabilityFilter = document.getElementById('availability-filter');
            const distanceFilter = document.getElementById('distance-filter');

            const regForm = document.getElementById('register-operator-form');
            const regNameInput = document.getElementById('operator-name');
            const regContactInput = document.getElementById('contact-number');
            const regLocationInput = document.getElementById('location');
            const regAvailabilityInput = document.getElementById('availability');
            const verifyLocationBtn = document.getElementById('verify-location-btn');
            const regLatInput = document.getElementById('latitude');
            const regLngInput = document.getElementById('longitude');

            // --- NEW: Central function to fetch data from the API based on filters ---
            async function fetchAndRenderOperators() {
                operatorGrid.innerHTML = `<p>Loading operators...</p>`;
                
                const url = new URL(`${API_BASE_URL}/api/operators`);
                const nameTerm = operatorNameSearchInput.value.trim();
                const availability = availabilityFilter.value;
                const maxDistance = distanceFilter.value;

                // Append search parameters to the URL
                if (nameTerm) url.searchParams.append('name', nameTerm);
                if (availability !== 'all') url.searchParams.append('availability', availability);
                
                // Append location parameters if a search location is set
                if (searchCoordinates) {
                    url.searchParams.append('lat', searchCoordinates.lat);
                    url.searchParams.append('lon', searchCoordinates.lng);
                    if (maxDistance !== 'any') {
                        url.searchParams.append('distance', maxDistance);
                    }
                }

                try {
                    const response = await fetch(url.toString());
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    
                    const operators = await response.json();
                    renderOperators(operators);
                } catch (error) {
                    console.error('Failed to fetch operators:', error);
                    operatorGrid.innerHTML = `<p>Error loading operators. Is the backend server running?</p>`;
                }
            }

            // --- Rendering Function (Unchanged, it works perfectly) ---
            const renderOperators = (operators) => {
                operatorGrid.innerHTML = '';
                if (!operators || operators.length === 0) {
                    operatorGrid.innerHTML = `<p data-key="no_operators_text">No operators found matching your criteria.</p>`;
                } else {
                    operators.forEach(op => {
                        const availabilityClass = op.availability_status === 'available' ? 'status-available' : 'status-unavailable';
                        
                        // The backend now provides the distance, so we just display it.
                        let distanceText = '';
                        if (op.distance !== null && op.distance !== undefined) {
                            distanceText = `<span class="operator-distance"> | ${op.distance.toFixed(1)} km away</span>`;
                        }

                        const cardHTML = `
                            <div class="operator-card">
                                <div class="operator-status">
                                    <h4 class="operator-name">${op.full_name}${distanceText}</h4>
                                    <span class="${availabilityClass}">${op.availability_status.charAt(0).toUpperCase() + op.availability_status.slice(1)}</span>
                                </div>
                                <div class="operator-meta">
                                    <span><i class="fas fa-phone"></i> <a href="tel:${op.contact_number}">${op.contact_number}</a></span>
                                    <span><i class="fas fa-map-marker-alt"></i> <span>${op.location_name}</span></span>
                                </div>
                                <button class="hire-btn">Hire Now</button>
                            </div>
                        `;
                        operatorGrid.insertAdjacentHTML('beforeend', cardHTML);
                    });
                }
            };

            // --- Geocoding Helper (Used for both search and registration) ---
            async function geocodeLocation(locationName) {
                if (!locationName) return null;
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationName)}&format=json&limit=1&countrycodes=in`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response for geocoding was not ok');
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    }
                    alert('Location not found. Please try a more specific address.');
                    return null;
                } catch (error) {
                    console.error("Geocoding Error:", error);
                    alert("Could not find the location due to a network error.");
                    return null;
                }
            }

            // --- CORRECTED: Registration form submission logic ---
            async function registerOperator(event) {
                event.preventDefault();
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('You must be logged in to register as an operator.');
                    // Optionally redirect to login page
                    // window.location.href = '/login.html'; 
                    return;
                }

                if (!regLatInput.value || !regLngInput.value) {
                    alert('Please click the "Verify" button to confirm your location before registering.');
                    regLocationInput.style.border = "2px solid red";
                    return;
                }

                const payload = {
                    fullName: regNameInput.value.trim(),
                    contactNumber: regContactInput.value.trim(),
                    locationName: regLocationInput.value.trim(),
                    availability: regAvailabilityInput.value
                };

                // Simple validation
                if (!payload.fullName || !payload.contactNumber || !payload.locationName) {
                    alert('Please fill out all required fields.');
                    return;
                }

                const submitButton = regForm.querySelector('.submit-btn');
                submitButton.disabled = true;
                submitButton.textContent = 'Registering...';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/operators`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.msg || 'Registration successful!');
                        regForm.reset();
                        regLocationInput.style.border = "1px solid var(--text-dark)";
                        fetchAndRenderOperators(); // Refresh the list to show the new operator
                    } else {
                        // Throw an error to be caught by the catch block
                        throw new Error(result.msg || 'An unknown error occurred during registration.');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    alert(`Registration Failed: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Register';
                }
            }

            // --- EVENT LISTENERS (All now trigger a new API call) ---
            locationSearchBtn.addEventListener('click', async () => {
                const locationName = locationSearchInput.value;
                if (!locationName) {
                    searchCoordinates = null; // Clear location if input is empty
                    alert('Location search cleared.');
                } else {
                    searchCoordinates = await geocodeLocation(locationName);
                }
                fetchAndRenderOperators(); // Fetch results with the new coordinates
            });
            
            operatorNameSearchInput.addEventListener('keyup', fetchAndRenderOperators);
            availabilityFilter.addEventListener('change', fetchAndRenderOperators);
            distanceFilter.addEventListener('change', fetchAndRenderOperators);
            
            // Event listener for the registration form
            regForm.addEventListener('submit', registerOperator);
            
            // Event listener for the location verification button in the form
            verifyLocationBtn.addEventListener('click', async () => {
                 const locationName = regLocationInput.value.trim();
                 if (!locationName) {
                     alert("Please enter a location to verify.");
                     return;
                 }
                 const coords = await geocodeLocation(locationName);
                 if (coords) {
                     regLatInput.value = coords.lat;
                     regLngInput.value = coords.lng;
                     regLocationInput.style.border = "2px solid green";
                     alert(`Location verified successfully! Latitude and Longitude have been set.`);
                 } else {
                     regLatInput.value = '';
                     regLngInput.value = '';
                     regLocationInput.style.border = "2px solid red";
                 }
            });

            // --- INITIALIZATION ---
            fetchAndRenderOperators(); // Fetch initial data on page load
        });
    </script>
</body>
</html>